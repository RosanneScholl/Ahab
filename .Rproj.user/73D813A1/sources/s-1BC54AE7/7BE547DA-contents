---
title: "Browser usage survey: browser use and installation"
output:
  html_document:
    toc: yes
  pdf_document:
    number_sections: yes
    toc: yes
  word_document:
    toc: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r, include=FALSE}
# preliminaries-----

library(haven)
library("reshape2")
library("ggplot2")
library("dplyr")

setwd('/home/bcolloran/Desktop/The Strategy Team - Mozilla Files 2016-02-13/')

d = haven::read_spss('SPSS Data Files/Mozilla Survey_cleaned_processed.sav')

# http://www.census.gov/quickfacts/table/PST045215/00
US_POP_ALL = 318857056
under18Prop = .231
# US_POP_ALL*(1-under18Prop)

qualificationRate = .932

US_POP = 2.4117E8 # Cumul. Freq. from "Mozilla Appendices", p13-14
US_POP_QUAL = US_POP * qualificationRate

US_POP_RESCALE = US_POP_QUAL
```


```{r, include=FALSE}
# functions
weightedMean = function(series,filter){
  sum(series[filter]*d$weight[filter])/sum(d$weight[filter])
}

weightedMeanNotNa = function(series){weightedMean(series,!is.na(series))}

coocurrenceMatFromFrame = function(df,numOptions){
  M = matrix(nrow = numOptions,ncol = numOptions)
  # browser co-occurence table
  for (i in 1:numOptions ) {
    for (j in 1:(length(df)-1) ) {
      ni = names(df)[i]
      nj = names(df)[j]
      M[[i,j]]= sum((df[[ni]] & df[[nj]])*df[["weight"]])/sum(df[["weight"]])
    }
  }
  colnames(M) = names(df)[1:numOptions]
  rownames(M) = names(df)[1:numOptions]
  return(M)
}

labeledMatrixPlot  = function(M,plotTitle,labelFmtStr,labelMult, lower = F, diverging = F){
  if (lower){
    M = M*upper.tri(M,1)
  }
  
  if (diverging){
    gradient = scale_fill_gradient2(guide = "none", na.value = "white")
  } else {
    gradient = scale_fill_gradientn(colours=c("white","green"),
                         # values=c(0,1),
                         guide = "none", na.value = "white")
  }
  cor_dat <- melt(M)
  item_names = colnames(M)
  cor_dat$Var1 <- factor(cor_dat$Var1, levels=item_names)
  cor_dat$Var2 <- factor(cor_dat$Var2, levels=rev(item_names))
  cor_dat$pctile <- rank(cor_dat$value, na.last="keep")/sum(!is.na(cor_dat$value))
  # print(cor_dat)
  ggplot(data = cor_dat, aes(x = Var1, y = Var2)) +
    geom_tile(aes(fill = value), colour = "white") +
    geom_text(aes(label = ifelse(value==0,"",sprintf(labelFmtStr,value*labelMult))), vjust = 1) +
    gradient +
    coord_equal() +
    labs(x="",y="") +
    ggtitle(plotTitle)
}


labeledMatrixPlotPctAndCount  = function(M, plotTitle, lower = F){
  if (lower){
    M = M*upper.tri(M,1)
  }
  cor_dat <- melt(M)
  item_names = colnames(M)
  cor_dat$Var1 <- factor(cor_dat$Var1, levels=item_names)
  cor_dat$Var2 <- factor(cor_dat$Var2, levels=rev(item_names))
  cor_dat$pctile <- rank(cor_dat$value, na.last="keep")/sum(!is.na(cor_dat$value))
  ggplot(data =  cor_dat, aes(x = Var1, y = Var2)) +
    geom_tile(aes(fill = pctile), colour = "white") +
    geom_text(aes(label = ifelse(value==0,"",sprintf("%1.1f%%",value*100))), vjust = -.5) +
    geom_text(aes(label = ifelse(value==0,"",sprintf("%1.1f M",value*US_POP_RESCALE/1e6))), vjust = 1.5) +
    scale_fill_gradientn(colours=c("white","green"),
                         values=c(0,1),
                         guide = "none", na.value = "white") +
    coord_equal() +
    labs(x="",y="") +
    ggtitle(plotTitle)
}

naTo0 = function(series){series[is.na(series)] <- 0; series}



```



# Introduction and background

In 2015Q4-2016Q1, Mozilla ran a survey of US internet Users (age 18+) to investigate the use web browsers, devices, and a small set of internet behaviors. This survey was intended to provide us with insights that we are currently lacking about the use of Firefox and competing browsers, including:
 - an additional estimate of the size of our US user base (and the user numbers of our competitors),
 - an estimate of non-exclusive usage share (including people who use multiple browsers),
 - insight into common patterns of multiple browser use, 
 - use of browsers on different desktop OSes,
 - use of different devices for web browsing,
 - browser installation on desktop/laptop devices,
 - browsing behavior using different browsers,
 - as well as a few other metrics,
 - detailed background demographic information.
For this survey, attitudinal and stated-preference questions were explicitly out-of-scope, but the robust demographic and behavioral information returned by this research is a natural complement to and starting point for further research into user beliefs, attitudes, perceptions and preferences.

# Browser usage in the last 30 days (all browsers, including mobile)

We asked two set of questions about browser usage; we first asked "During	the	last 30 days, did you use	{BROWSER}, or	did	you	not	use	it in	the	last 30 days?", for Firefox, Chrome, Internet Explorer, Safari, Edge, and Other. This question did not ask the user to specify the device on which they used the browser, so for example if they answered that they had used Safari in the last 30 days, they could be including Safari on Mac or iOS. Later in the survey we ask for details about desktop browsers; this question gives insight into exposure to browser brands generally.

```{r, include=FALSE}
#usage in the last 30 days
usageLast30 = data.frame(
  chrome = (d$q7_rc==1)[!is.na(d$q7_rc)],
  ie =     (d$q7b_rc==1)[!is.na(d$q7_rc)],
  safari = (d$q7c_rc==1)[!is.na(d$q7_rc)],
  ff =     (d$q7d_rc==1)[!is.na(d$q7_rc)],
  edge =   (d$q7e_rc==1)[!is.na(d$q7_rc)],
  other =  (d$q8_rc==1)[!is.na(d$q7_rc)],
  weight = (d$weight)[!is.na(d$q7_rc)]
)
numBrowsers = 6
```


### Browser usage (all browsers, including mobile)

Our survey is able to take us beyond "market share" (which assigns each user to a single browser) by asking each individual to enumerate all of the browsers they use. This allows us to see that about 30% of users have used Firefox in the last 30 days, which is substantially higher than the "market share" numbers given by StatCounter and NetMarket. Note also, though, that when we pool all browser interactions (desktop and mobile), we see that substantially more people have used Safari than Firefox.

```{r, echo=FALSE}
usageLast30_coocMat = coocurrenceMatFromFrame(usageLast30,numBrowsers)
barplot(diag(usageLast30_coocMat),
        ylim = c(0,1),
        xlab = "",
        ylab = "Proportion of population using browser",
        main = "Browsers usage in the last 30 days\n(US users >=18, including mobile)")
```


## Multiple browser usage (all browsers, including mobile)

Beyond the simple percentages of the population using different browsers, some of the most interesting questions we can address with this survey revolve around the use of multiple browser brands: how many people use more than one browser, how many browsers do people use on average, and what combinations of browsers do people use.

### Average number of browsers used in the last 30 days (all browsers, including mobile)

Most people in the US have used multiple browser in the last 30 days; indeed the average US Internet user has used 2.1 browsers in the last 30 days. (Note that some Internet users may have zero browser if they reported having used the internet exclusively through mobile apps, email clients, or other non-web Internet applications.)

```{r, echo=FALSE}
# average number of browsers used in last 30 days
avgNumUsedLast30=sum(rowSums(usageLast30[1:numBrowsers]*usageLast30$weight))/sum(usageLast30$weight) 

usageLast30_numUsed = data.frame(
  n0 = (rowSums(usageLast30[1:numBrowsers])==0),
  n1 = (rowSums(usageLast30[1:numBrowsers])==1),
  n2 = (rowSums(usageLast30[1:numBrowsers])==2),
  n3 = (rowSums(usageLast30[1:numBrowsers])==3),
  n4 = (rowSums(usageLast30[1:numBrowsers])==4),
  n5 = (rowSums(usageLast30[1:numBrowsers])==5),
  n6 = (rowSums(usageLast30[1:numBrowsers])==6),
  # n7 = (rowSums(usageLast30[1:numBrowsers])==7),
  # n8 = (rowSums(usageLast30[1:numBrowsers])==8),
  weight = usageLast30$weight
)

usageLast30_numUsed_summary=list()
# usageLast30_numUsed_summary[4]=4
for (i in 1:(numBrowsers+1)){
  usageLast30_numUsed_summary[i] = sum(rowSums(usageLast30_numUsed[i])*usageLast30_numUsed$weight)
}
barplot(unlist(usageLast30_numUsed_summary)/sum(unlist(usageLast30_numUsed_summary)),
        names.arg = 0:numBrowsers,
        ylim = c(0,1),
        xlab = "Number of browsers",
        ylab = "Proportion of population",
        main = "Number of browsers used in the last 30 days\n(US users >=18, including mobile)")
```



### Browser usage combination matrix (all browsers, including mobile)

Following from the information above, the next issue of interest is what combinations of browsers people use.  The following two plots show the number of people that use each pairwise browser combination (first as a percentage of the population, then as an estimate of the actual population count). The values on the diagonal are simply the total number of people that have used the browser in question in the last 30 days (these numbers match the bar plot above).

```{r, echo=FALSE}
labeledMatrixPlotPctAndCount(
  usageLast30_coocMat,
  "Multiple browser use, Desktop and mobile\n(US users >=18; % and millions)",
  lower = F)
```

```{r, echo=FALSE}
#do a matrix with the DEPARTURE from the combination that would be expected if each combinations were distributed independently at random based on the marginal totals

```










# Desktop browsers usage in the last 30 days

```{r,echo=0}
# q16/q16a/q16b ask about browser time % on windows/mac/linux
# browsers are numbered: 

# the following is computed by summing the pct of time that each respondent used each
# browser across operating systems, and countint the user as having used
#the browser if it is >0
desktopBrowserUse = data.frame(
  chrome = rowSums(d[c("q16_01","q16b_01","q16c_01")],na.rm = 1) > 0, #chrome
  ie = rowSums(d[c("q16_02")],na.rm = 1) > 0, #ie
  safari = rowSums(d[c("q16b_03")],na.rm = 1) > 0, #safari
  ff = rowSums(d[c("q16_04","q16b_04","q16c_04")],na.rm = 1) > 0, #firefox
  edge = rowSums(d[c("q16_05")],na.rm = 1) > 0, #edge
  other = rowSums(d[c("q16_06","q16b_06","q16c_06")],na.rm = 1) > 0, #other
  weight = d$weight)
```

In addition to asking about browser usage in general, we also drill down into browser usage on desktop and laptop computers (which we'll refer to simply as "desktop"), both in general and by desktop OS.

One caveat: all of the numbers reported for desktop browser use are substantially lower than for device-non-specific browser use. We believe this to be a mixture of reality and respondent error -- for example, Safari use is clearly much lower on desktop than on all devices; however, Firefox use is lower on desktop than can be explained by Firefox for Android and iOS. Basically, for many users, the questions we are interested in are at the limit of their technical knowledge and mental model of the internet, the web, and browsing. Despite pre-testing, this is one place where that gap seems to have shown up.

### Desktop browser usage, 

When we look at desktop browser usage, we don't see any big surprises. Chrome and IE have been used by about half of US internet-using adults, Firefox by about one quarter, Safari by about 14%, and Edge by about 6%

```{r, echo=FALSE}
desktopBrowserUse_coocMat = coocurrenceMatFromFrame(desktopBrowserUse,numBrowsers)
barplot(diag(desktopBrowserUse_coocMat),
        xlab = "",
        ylab = "Proportion of population using browser",
        main = "Browsers usage in the last 30 days\n(US users >=18, Desktop only)",
        ylim = c(0,1))
```

## Multiple desktop browser usage

### Number of desktop browsers used in last 30 days

As was the case for browser use across device contexts, we can see that many people use multiple desktop browsers, but in the case of desktop it's a bit lower -- the population under consideration has used on average about 1.5 different browsers in the last 30 days. The major difference here is the large number of people who report having used zero desktop browsers -- around 17% of the internet-using adults in the US. (More on device usage below, or see TST report, p.24)

```{r, echo=FALSE}

avgNumDesktopUsedLast30 = sum(rowSums(desktopBrowserUse[1:numBrowsers]*desktopBrowserUse$weight))/sum(desktopBrowserUse$weight) 

desktopLast30_numUsed = data.frame(
  n0 = (rowSums(desktopBrowserUse[1:numBrowsers])==0),
  n1 = (rowSums(desktopBrowserUse[1:numBrowsers])==1),
  n2 = (rowSums(desktopBrowserUse[1:numBrowsers])==2),
  n3 = (rowSums(desktopBrowserUse[1:numBrowsers])==3),
  n4 = (rowSums(desktopBrowserUse[1:numBrowsers])==4),
  n5 = (rowSums(desktopBrowserUse[1:numBrowsers])==5),
  n6 = (rowSums(desktopBrowserUse[1:numBrowsers])==6),
  weight = desktopBrowserUse$weight
)

desktopLast30_numUsed_summary=list()

for (i in 1:(numBrowsers+1)){
  desktopLast30_numUsed_summary[i] = sum(rowSums(desktopLast30_numUsed[i])*desktopLast30_numUsed$weight)
  }

barplot(unlist(desktopLast30_numUsed_summary)/sum(unlist(desktopLast30_numUsed_summary)),
        names.arg = 0:numBrowsers,
        xlab = "Number of browsers",
        ylab = "Proportion of population",
        main = "Number of browsers used in the last 30 days\n(US users >=18, desktop only)")
```

### Browser usage combination matrix (desktop only)

Browser appear in essentially the same combinations on desktop as they do across all devices, with the exception of Safari which appears less overall.

In the second plot below, we compare the observed level of multiple-browser use to the level that would be expected if multiple browser use were determined at random based only on the overall proportion of people who use each browser. As expected, we see that the combination of Safari and IE is less common than we would expect based on chance -- a consequence of many people using only Mac or Windows computers. This difference from random choice is actually quite a bit smaller than might have been expected in advance if we thought that most people only ever use one OS, but this turns out not to be the case (more on multiple OS use below).

Note that the numbers in the second plot for "Edge" and "Other" are based on a relatively small number of respondents, and therefore should be regarded cautiously.

```{r, echo=FALSE}
# ever used each browser on desktop?
labeledMatrixPlotPctAndCount(
  desktopBrowserUse_coocMat,
  "Multiple browser use, Desktop only\n(US users >=18; % and millions)",
  lower = 0)

# compare to random usage based on margins
desktopUse_marginal = diag(desktopBrowserUse_coocMat)
desktopBrowserUse_coocMat_random = matrix(desktopUse_marginal,nrow = numBrowsers,ncol = numBrowsers) *
  matrix(desktopUse_marginal,nrow = numBrowsers,ncol = numBrowsers,byrow = 1)
desktopUse_diffFromRandom = desktopBrowserUse_coocMat - desktopBrowserUse_coocMat_random
diag(desktopUse_diffFromRandom)=0

labeledMatrixPlot(desktopUse_diffFromRandom,
                  "Multiple browser use, difference from random\n(% of US users >=18, Desktop)",
                  "%1.1f%%",100,lower = 0,diverging = 1)
```

## Hours of desktop browser use

In the desktop context, we've also asked about the number of hours that people use each browser during a typical week. Below we show the population-total number of hours per week (in millions) for each browser estimated based on the survey (in orange), compared to the distribution of browsing hours that would result from all users of all browsers splitting their time evenly between the browsers they use (shown in light grey). Chrome and Firefox perform better than they would under a simple proportional split, while Safari, IE, and Edge do worse (note that this is zero-sum). This suggests that the people who stick with default browsers (IE and Safari) browse proportionally less. Notably, Safari under performs substantially more than IE, which may indicate that Mac users are more likely to switch to an alternative browser, and that those mac users who do not bother to do so are light browsers.

```{r, echo=F, message=FALSE, warning=FALSE}
# hoursPerBrowser = c(weightedMeanNotNa(d$comp_chromehours),
# weightedMeanNotNa(d$comp_iehours),
# weightedMeanNotNa(d$comp_firefoxhours),
# weightedMeanNotNa(d$comp_safarihours),
# weightedMeanNotNa(d$comp_edgehours),
# weightedMeanNotNa(d$comp_otherhours) )
# hoursPerBrowser/sum(hoursPerBrowser)
## the above numbers match the figure in TSTp2

nameOrder = plyr::mapvalues(names(desktopUse_marginal),from = "ff",to="firefox")
hoursPerBrowser = Map(function(s){weightedMeanNotNa(d[[sprintf("comp_%shours",s)]])},nameOrder) %>% unlist

totalHoursPerBrowser = US_POP_RESCALE * hoursPerBrowser
totalHoursDesktop = sum(totalHoursPerBrowser)
totalHoursPerBrowser_nullModel = totalHoursDesktop * desktopUse_marginal/sum(desktopUse_marginal)
# (totalHoursPerBrowser)/totalHoursPerBrowser_nullModel
# hoursPerBrowser/sum(hoursPerBrowser)

hoursComparison = data.frame(
  browser = nameOrder,
  observed_hours = totalHoursPerBrowser/1e6,
  proportional_hours = totalHoursPerBrowser_nullModel/1e6)

ggplot(melt(hoursComparison),aes(x=browser,y=value, fill = variable)) +
  geom_bar(stat="identity",position = "dodge") +
  scale_x_discrete(limits = nameOrder) +
  xlab("") +
  ylab("Millions of hours of browser use per week\n") +
  theme_bw() +
  # scale_fill_discrete(name="Who installed\nthe browser?\n") +
  ggtitle("Total weekly hours of desktop browser use\n(US users >=18)") +
  scale_fill_manual(values=c("#E69F00","#dfdfdf"),name="Who installed\nthe browser?\n")

```

# Desktop OS usage and browser usage by OS

## OS use co-ocurrence

In addition to collecting information on the usage of multiple browsers, we also asked about the use of multiple desktop operating systems. Again, this takes us beyond market share and allow us to think more deeply about the multi-device environment in which many people are operating. The data shown on the diagonal in the plot below is not surprising: 90% of US internet users have used Windows in the last 30 days, 21% have used a Mac, and 3% have used Linux. More interesting is the fact that over half of those people that have used a Mac have also used Windows, and about 1 in 8 of those who have used Windows have also used a Mac.

```{r, echo=FALSE}
# d$dov_winhours & d$dov_machours
# na.omit()
osHours = na.omit(d[,c("dov_winhours","dov_machours","dov_linhours","weight")])
M_os = coocurrenceMatFromFrame(osHours,3)
rownames(M_os) = c("Windows","Mac","Linux")
colnames(M_os) = rownames(M_os)

labeledMatrixPlotPctAndCount(M_os,
                  "Multiple desktop OS usage\n(US users >=18, % and millions)")

```

## Browser use conditioned on desktop OS

Below we present information on browser use by desktop operating system. The main take away here is a reaffirmation of something we've known for a long time: defaults matter.  On Windows and Mac, IE and Safari respectively are still used by more people than any competing browser. However, both of thees browsers also account for a smaller share of usage hours than would be expected if usage hours were distributed evenly across browser according to the number of people using each browser, which confirms another expected finding: those users that actively choose a browser are more likely to be heavier web users.

### Browser use on windows

```{r, echo=FALSE}
desktopBrowserHours_win = data.frame(
  chrome = d$dov_winchromehours, #chrome
  ie = d$dov_winiehours, #ie
  ff = d$dov_winfirefoxhours, #firefox
  edge = d$dov_winedgehours, #edge
  other = d$dov_winotherhours, #other
  weight = d$weight)

M_winhours = coocurrenceMatFromFrame(naTo0(desktopBrowserHours_win),5)

labeledMatrixPlotPctAndCount(M_winhours,
                  "Multiple browser usage on Windows\n(US users >=18, % and millions)")


barplot(US_POP/1e6 * colSums(naTo0(desktopBrowserHours_win[,1:5] * d$weight))/sum(d$weight),
        ylab ="millions of hours",
        main = "Total person-hours of browser use per week\n(US users >=18, Windows Desktop)")
```

### Browser use on mac

```{r, echo=FALSE}
desktopBrowserHours_mac = data.frame(
  chrome = d$dov_macchromehours, #chrome
  safari = d$dov_macsafarihours, #ie
  ff = d$dov_macfirefoxhours, #firefox
  other = d$dov_macotherhours, #other
  weight = d$weight)

M_machours = coocurrenceMatFromFrame(naTo0(desktopBrowserHours_mac),4)

labeledMatrixPlotPctAndCount(M_machours,
                  "Multiple browser usage on Mac\n(US users >=18, % and millions)")

barplot(US_POP/1e6 * colSums(naTo0(desktopBrowserHours_mac[,1:4] * d$weight))/sum(d$weight),
        ylab ="millions of hours",
        main = "Total person-hours of browser use per week\n(US users >=18, Mac Desktop)")

```

### Browser use on linux

```{r, echo=FALSE}
desktopBrowserHours_linux = data.frame(
  chrome = d$dov_linchromehours, #chrome
  ff = d$dov_linfirefoxhours, #firefox
  other = d$dov_linotherhours, #other
  weight = d$weight)

M_linuxhours = coocurrenceMatFromFrame(naTo0(desktopBrowserHours_linux),3)

labeledMatrixPlotPctAndCount(M_linuxhours,
                  "Multiple browser usage on Linux\n(US users >=18, % and millions)")

barplot(US_POP/1e6 * colSums(naTo0(desktopBrowserHours_linux[,1:3] * d$weight))/sum(d$weight),
        ylab ="millions of hours",
        main = "Total person-hours of browser use per week\n(US users >=18, linux Desktop)")

```



```{r, include=FALSE}

# Most used desktop browsers per user, including users of more than one os
d$comp_chrome
mostUsedPerUser =  d[,c("mostusedbrowser_rc","weight")] %>% 
  group_by(mostusedbrowser_rc) %>% 
  summarise(users = sum(weight)) %>%
  arrange(desc(users))

options(dplyr.print_max = 100)
# 
mostUsedPerUser

# this is not an encouraging result-- "other browsers including:" being higher than Safari suggests confusion 

d[1:100,c("dov_mt","mostusedbrowser_rc","comp_chrome","comp_ie","comp_safari","comp_firefox","comp_ie","comp_other","weight")]
# it appears that users who have 0 across the board for the comp_* variables
# (INCLUDING comp_other!!!) are labeled as "other",
# which is surely not correct. need to recheck the calculations.


```

# Desktop browser installation

We also asked about the installation of desktop browsers. Users were asked it the browser they use most often was already installed on their most-used computer when they started using that computer. Among users who were asked this question, about 56% said their browser was already installed, 34% said it was not already installed, and about 11% said they did not know if it was already installed.

Some key takeaways here are:
 - only about a third of people know that their browser was not pre-installed,
 - of those people who knew their browser was not pre-installed, the vast majority did the installation themselves,
 - of those who know their browser was installed by someone else, in the vast majority of cases it was installed by a family member.

Below, we dig into the details of installation by browser.

## "Was your most used browser already installed?" (per browser)

Below we show the estimated number of most-used browser instances by their installation status, as well as the percentage of instances having each installation status among instances of that browser.

```{r, echo=FALSE}
installed = c(1473.5, 893.5, 281.4)
# installed/sum(installed)

# d$mostusedbrowser_rc
# d[,c("mostusedbrowser_rc","weight","q16d","q16e","q17_rc","q18","q19")]

installation   = d[,c("dov_mt","weight","q16d","q16e","q17_rc","q18","q19")]

# installation %>% head(30)

### most used qua dov_mt
# d[,c("dov_mt","weight")] %>%
#   group_by(dov_mt) %>%
#   summarise(users = sum(weight)) %>%
#   arrange(desc(users))
# 
# d$dov_mt
# as.double(d$mostusedbrowser_rc)

installationCheck = data.frame(
  mostUsed = as.double(d$mostusedbrowser_rc),
  weight = d$weight,
  inst = naTo0(d$q17_rc==1)*d$weight + naTo0(d$q17_rc==2)*d$weight + naTo0(d$q17_rc==3)*d$weight,
  instMe = naTo0(d$q18==1)*d$weight + naTo0(d$q18==2)*d$weight + naTo0(d$q18==3)*d$weight,
  instBy = naTo0(d$q19==1)*d$weight + naTo0(d$q19==2)*d$weight + naTo0(d$q19==3)*d$weight +     naTo0(d$q19==4)*d$weight +naTo0(d$q19==5)*d$weight)

# installationCheck %>% head
# installationCheck[installationCheck$weight!=installationCheck$inst,]

installation2 = data.frame(
  mostUsed = as.double(d$mostusedbrowser_rc),
  weight = d$weight,
  inst_already = naTo0(d$q17_rc==1)*d$weight,
  inst_notAlready = naTo0(d$q17_rc==2)*d$weight,
  inst_dunno = naTo0(d$q17_rc==3)*d$weight,
  instMe_me = naTo0(d$q18==1)*d$weight,
  instMe_notMe = naTo0(d$q18==2)*d$weight,
  instMe_dontKnow = naTo0(d$q18==3)*d$weight,
  instBy_friend = naTo0(d$q19==1)*d$weight,
  instBy_fam = naTo0(d$q19==2)*d$weight,
  instBy_emp = naTo0(d$q19==3)*d$weight,
  instBy_cowo = naTo0(d$q19==4)*d$weight,
  instBy_dunno = naTo0(d$q19==5)*d$weight,
  stringsAsFactors=FALSE)

# installation2 %>% head(30)


# from TST recode:
# label define mostusedbrowser_rc 1 "chrome" 2 "internet explorer" 3 "safari" 4 "firefox" 5 "edge" 6 "other", replace
recodeNumToBrowserStr = function(x){switch (x,"chrome","ie","safari","ff","edge") } 

# Data for "other" is not good in this context, b/c it includes other not on desktop??
# -- no, it seems to be that people with comp_*==0 were all lumped into other

installationSummary = installation2 %>%
  filter(!is.na(mostUsed)) %>%  #drop rows with no most used browser
  filter(mostUsed!=6) %>% #drop rows with "other" most used browser
  group_by(mostUsed) %>% 
  summarise_each(funs(sum)) %>%
  arrange(desc(weight)) %>%
  mutate(mostUsed = mapply(recodeNumToBrowserStr,mostUsed))



rownames(installationSummary) = installationSummary$mostUsed

# installationSummary %>% select(starts_with("inst_"))
  
# installationSummary 

preInstalled_UsPopCountsMillions_melt = installationSummary[,c("mostUsed","inst_already", "inst_notAlready", "inst_dunno")] %>%
  transmute(mostUsed,
         already_installed = inst_already*US_POP/(1e6*sum(d$weight)),
         not_already_installed=inst_notAlready*US_POP/(1e6*sum(d$weight)),
         not_sure=inst_dunno*US_POP/(1e6*sum(d$weight))) %>%
  melt(id.vars = "mostUsed")

preInstalled_melt_pct = installationSummary[,c("mostUsed","inst_already", "inst_notAlready", "inst_dunno","weight")] %>%
  mutate(newWeight = inst_already+inst_notAlready+inst_dunno) %>%
  transmute(mostUsed=mostUsed,
            inst_already = inst_already/newWeight,
         inst_notAlready = inst_notAlready/newWeight,
         inst_dunno = inst_dunno/newWeight ) %>%
  select(mostUsed,
         already_installed = inst_already,
         not_already_installed=inst_notAlready,
         not_sure=inst_dunno) %>%
  melt(id.vars = "mostUsed")


ggplot(preInstalled_UsPopCountsMillions_melt, aes(x=mostUsed, y=value, fill=variable)) + 
  geom_bar(stat="identity") +
  xlab("") +
  ylab("Millions of instances\n") +
  theme_bw() +
  scale_fill_discrete(name="Browser already\ninstalled when\ncomputer first used?") +
  ggtitle("Preexisting installation status of most-used\nbrowser on most-used computer")

cat("")

ggplot(preInstalled_melt_pct, aes(x=mostUsed, y=value, fill=variable)) + 
  geom_bar(stat="identity") +
  xlab("") +
  ylab("Proportion of instances\n") +
  theme_bw() +
  scale_fill_discrete(name="Browser already\ninstalled when\ncomputer first used?") +
  ggtitle("Preexisting installation status of most-used\nbrowser on most-used computer\n(proportion of instances by browser)")
```

## "If your most used browser was not already installed, did you install it?" (per browser)

Here we show the estimated number of browser instances that were not already installed when the respondent began using their most-used computer, broken down by whether the user did the installation or someone else did.

Note that the proportions are not statistically different for Chrome and Firefox, and the numbers for manual installations of IE and Safari are too low to draw meaningful inference.

```{r, echo=FALSE}

## out of browsers that were not already installed--


notAlreadyInstalled_UsPopCountsMillions_melt = installationSummary[,c("mostUsed","instMe_me", "instMe_notMe", "instMe_dontKnow")] %>%
  transmute(mostUsed,
         installed_by_user = instMe_me*US_POP/(1e6*sum(d$weight)),
         installed_by_other = instMe_notMe*US_POP/(1e6*sum(d$weight)),
         installed_by_unknown = instMe_dontKnow*US_POP/(1e6*sum(d$weight))) %>%
  melt(id.vars = "mostUsed")

notAlreadyInstalled_pct_melt = installationSummary[,c("mostUsed","instMe_me", "instMe_notMe", "instMe_dontKnow")] %>%
  mutate(newWeight = instMe_me + instMe_notMe + instMe_dontKnow) %>%
  transmute(mostUsed,
         installed_by_user = instMe_me/newWeight,
         installed_by_other = instMe_notMe/newWeight,
         installed_by_unknown = instMe_dontKnow/newWeight) %>%
  filter(mostUsed!="ie" & mostUsed!="safari") %>%
  melt(id.vars = "mostUsed")
  

ggplot(notAlreadyInstalled_UsPopCountsMillions_melt, aes(x=mostUsed, y=value, fill=variable)) + 
  geom_bar(stat="identity") +
  xlab("") +
  ylab("Millions of instances\n") +
  theme_bw() +
  scale_fill_discrete(name="Who installed\nthe browser?\n") +
  ggtitle("Who installed the most-used browser\n(among browsers not already installed)\n")


cat("")

ggplot(notAlreadyInstalled_pct_melt, aes(x=mostUsed, y=value, fill=variable)) + 
  geom_bar(stat="identity") +
  xlab("") +
  ylab("Proportion of instances\n") +
  theme_bw() +
  scale_fill_discrete(name="Who installed\nthe browser?\n") +
  ggtitle("Who installed the most-used browser\n(among browsers not already installed;\nproportion of instances by browser)\n")

```

## "If your most used browser was not already installed and you did not install it, who installed it?" (per browser)

Among those browser instances that were not already installed when the respondent began using their most-used computer, and that were not installed by the user, we now break down the instances by what other person did the installation.

In this case, the number of installations done by someone other than the user was only large enough to be worth presenting in the cases of Chrome and Firefox. However, the number of responses was too low to state that there is any significant difference in the proportion of installs performed by the different categories of other people considered -- that is, we cannot confidently say that Chrome is really installed more often by employers than Firefox.

```{r, echo=FALSE}

## Chrome and FF installed by other


installedByOther_UsPopCountsMillions_melt = installationSummary[,c("mostUsed","instBy_friend", "instBy_fam","instBy_emp", "instBy_cowo", "instBy_dunno"   )] %>%
  filter(mostUsed=="chrome" | mostUsed=="ff") %>%
  transmute(mostUsed,
         friend = instBy_friend*US_POP/(1e6*sum(d$weight)),
         family = instBy_fam*US_POP/(1e6*sum(d$weight)),
         employer = instBy_emp*US_POP/(1e6*sum(d$weight)),
         coworker = instBy_cowo*US_POP/(1e6*sum(d$weight)),
         unknown = instBy_dunno*US_POP/(1e6*sum(d$weight))) %>%
  melt(id.vars = "mostUsed")

installedByOther_pct_melt = installationSummary[,c("mostUsed","instBy_friend", "instBy_fam","instBy_emp", "instBy_cowo", "instBy_dunno"   )] %>%
  filter(mostUsed=="chrome" | mostUsed=="ff") %>%
  mutate(newWeight = instBy_friend + instBy_fam + instBy_emp + instBy_cowo + instBy_dunno) %>%
  transmute(mostUsed,
         friend = instBy_friend/newWeight,
         family = instBy_fam/newWeight,
         employer = instBy_emp/newWeight,
         coworker = instBy_cowo/newWeight,
         unknown = instBy_dunno/newWeight) %>%
  melt(id.vars = "mostUsed")
  

ggplot(installedByOther_UsPopCountsMillions_melt, aes(x=mostUsed, y=value, fill=variable)) + 
  geom_bar(stat="identity") +
  xlab("") +
  ylab("Millions of instances\n") +
  theme_bw() +
  # scale_fill_discrete(name="If not the user, who\ninstalled the instance?\n")
  scale_fill_discrete(name="Installer\n") +
  ggtitle("If not the user, who installed the most-used browser?\n(number of instances installed by\nsomeone other than the user)")

cat("")

ggplot(installedByOther_pct_melt, aes(x=mostUsed, y=value, fill=variable)) + 
  geom_bar(stat="identity") +
  xlab("") +
  ylab("Proportion of instances\n") +
  theme_bw() +
  scale_fill_discrete(name="Installer\n") +
  ggtitle("If not the user, who installed the most-used browser?\n(proportion of instances installed by someone\nother than the user, by browser)\n")

```




```{r, echo=0, include=0}
# compare distribution of browsing by device, conditional on having used the device >0 hours
# NEED TO USE WEIGHTS FOR DENSITIES

browsingHoursByDevice = data.frame(
  desktop.or.laptop = d$dov_desktopbrowshours,
  tablet = d$dov_tabletbrowserhours,
  cell = d$dov_cellbrowserhours
  )

is.na(browsingHoursByDevice)

browsingHoursByDevice[is.na(browsingHoursByDevice)]=0

browsingHoursByDevice$weight = d$weight
browsingHoursByDevice$total = browsingHoursByDevice$desktop.or.laptop + browsingHoursByDevice$tablet + browsingHoursByDevice$cell

library(Hmisc)
wtd.quantile(browsingHoursByDevice$total, weights = browsingHoursByDevice$weight,(0:6)/6)

# d$dov_desktopbrowshours,
# d$dov_tabletbrowserhours,
# d$dov_cellbrowserhours

# ggplot(d, aes(x = dov_cellbrowserhours)) + geom_density(bw=.1)

plot(density(browsingHoursByDevice$desktop.or.laptop))
plot(density(browsingHoursByDevice$tablet))
plot(density(browsingHoursByDevice$cell))


```




```{r, echo=FALSE, include=0}

# percent of browsing time by os (q14)


# what is ff share like among users who make a choice?
# device co-occurence

# compare distribution of browser hours conditional on having used the browser >0 hours


# list of browsers entered in "other"


# q8a_* are the open-ended text entry boxes for 'other'
# names(d)
# names(d)[grep("q8a_",names(d))]


otherEntries = d[names(d)[grep("q8a_",names(d))]]
# sort(unique(otherEntries[otherEntries!=""]))
cat(sprintf("%s\n",unique(as.vector(as.matrix(otherEntries))) %>% sort()))

# q16d which "other" do you use most?
# q16e do you really use it most
# d[c("q16d","q16e")]
subset(d[c(names(d)[grep("q8a_",names(d))],"q16d","q16e")], q16e==1)
# otherEntries[naTo0(d$q16e==1),]
```
